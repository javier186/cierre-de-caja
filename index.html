<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cierre de Caja - Multi-Tienda</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Librer√≠as existentes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header .status {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .status.connected {
            color: #90EE90;
        }

        .status.disconnected {
            color: #FFB6C1;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            border-bottom: 4px solid #667eea;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .three-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .total-display .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-display .value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .photo-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .photo-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            border: 3px dashed #667eea;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-btn:hover {
            background: #f0f4ff;
            border-color: #764ba2;
            transform: scale(1.05);
        }

        .photo-btn .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        input[type="file"] {
            display: none;
        }

        .preview-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }

        video {
            width: 100%;
            max-width: 500px;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
        }

        .upload-area-simplit {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area-simplit:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .three-columns {
                grid-template-columns: 1fr;
            }

            .photo-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Sistema de Cierre de Caja</h1>
            <p>Control de Cierres Multi-Tienda</p>
            <div class="status" id="connectionStatus">üî¥ Conectando a base de datos...</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('registro')">
                üìù Registro de Cierre
            </div>
            <div class="tab" onclick="switchTab('consolidado')">
                üìä Consolidado & Verificaci√≥n
            </div>
        </div>

        <!-- TAB 1: REGISTRO DE CIERRE -->
        <div id="tab-registro" class="tab-content active">
            <div class="section">
                <div class="section-title">üè¨ Informaci√≥n de la Tienda</div>
                <div class="input-group">
                    <label>Selecciona tu Tienda:</label>
                    <select id="tiendaSelect">
                        <option value="">-- Selecciona tu tienda --</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Fecha del Cierre:</label>
                    <input type="date" id="fechaCierre">
                </div>
            </div>

            <div class="section">
                <div class="section-title">üí∞ Montos del Cierre</div>
                <div class="three-columns">
                    <div class="input-group">
                        <label>Cr√©dito (Bs):</label>
                        <input type="number" id="montoCredito" placeholder="0.00" step="0.01" value="0">
                    </div>
                    <div class="input-group">
                        <label>D√©bito (Bs):</label>
                        <input type="number" id="montoDebito" placeholder="0.00" step="0.01" value="0">
                    </div>
                    <div class="input-group">
                        <label>Pago M√≥vil (Bs):</label>
                        <input type="number" id="pagoMovil" placeholder="0.00" step="0.01" value="0">
                    </div>
                </div>

                <div class="total-display">
                    <div class="label">TOTAL CALCULADO</div>
                    <div class="value" id="totalCalculado">Bs 0.00</div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">üì∏ Foto del Cierre de Caja</div>
                <div class="photo-options">
                    <div class="photo-btn" id="takePictureBtn">
                        <div class="icon">üì∑</div>
                        <div style="font-weight: 600; color: #667eea;">Tomar Foto</div>
                    </div>
                    <div class="photo-btn" onclick="document.getElementById('galleryFile').click()">
                        <div class="icon">üñºÔ∏è</div>
                        <div style="font-weight: 600; color: #667eea;">Galer√≠a</div>
                    </div>
                </div>

                <input type="file" id="galleryFile" accept="image/*">
                <input type="file" id="cameraCapture" accept="image/*" capture="environment">

                <div id="cameraView" class="hidden">
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" id="captureBtn" style="width: auto; display: inline-block; margin-right: 10px;">üì∏ Capturar</button>
                        <button class="btn" id="closeCameraBtn" style="width: auto; display: inline-block; background: #dc3545;">‚ùå Cerrar</button>
                    </div>
                </div>

                <div class="preview-area" id="previewArea"></div>
            </div>

            <div class="section">
                <button class="btn" id="guardarBtn" disabled>üíæ Guardar Cierre en la Nube</button>
                <div class="alert alert-success hidden" id="successMsg">
                    ‚úÖ Cierre guardado exitosamente en la base de datos
                </div>
            </div>
        </div>

        <!-- TAB 2: CONSOLIDADO -->
        <div id="tab-consolidado" class="tab-content">
            <div class="section">
                <div class="section-title">üìä Cargar Datos de Simplit</div>
                <div class="alert alert-info">
                    üí° Carga el archivo Excel (.xlsx) o CSV con los datos de Simplit<br>
                    <strong>Columnas requeridas:</strong> Tienda, Fecha, Total_Ventas
                </div>
                <input type="file" id="simplitFile" accept=".csv,.xlsx,.xls">
                <div class="upload-area-simplit" onclick="document.getElementById('simplitFile').click()">
                    <div style="font-size: 3em; margin-bottom: 10px;">üìÅ</div>
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                        Arrastra el archivo de Simplit aqu√≠
                    </div>
                    <div style="color: #6c757d;">o haz clic para seleccionar</div>
                </div>
                <div id="simplitStatus" class="hidden"></div>
            </div>

            <div class="section">
                <div class="section-title">üìã Tabla Consolidada</div>
                <div class="alert alert-info">
                    üì° Los datos se cargan autom√°ticamente desde la nube
                </div>
                <div id="consolidadoContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando cierres desde la base de datos...</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <button class="btn btn-success" id="exportBtn" disabled>üì• Exportar a Excel</button>
                <button class="btn" id="clearDataBtn" style="background: #dc3545; margin-top: 10px;">üóëÔ∏è Limpiar Todos los Datos de la Nube</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIGURACI√ìN DE FIREBASE =====
        // üî¥ REEMPLAZA CON TUS DATOS DE FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyCyEw28OeV_ddZDWU6R0MOzgM5yffD94EU",
          authDomain: "sistema-cierres-caja.firebaseapp.com",
          projectId: "sistema-cierres-caja",
          storageBucket: "sistema-cierres-caja.firebasestorage.app",
          messagingSenderId: "12629027824",
          appId: "1:12629027824:web:07a5c3afe13c416bc40b35"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Verificar conexi√≥n
        db.collection('cierres').limit(1).get()
            .then(() => {
                document.getElementById('connectionStatus').textContent = 'üü¢ Conectado a la base de datos';
                document.getElementById('connectionStatus').className = 'status connected';
            })
            .catch((error) => {
                document.getElementById('connectionStatus').textContent = 'üî¥ Error de conexi√≥n';
                document.getElementById('connectionStatus').className = 'status disconnected';
                console.error('Error de conexi√≥n:', error);
            });

        // Variables globales
        let uploadedImage = null;
        let stream = null;
        let simplitData = [];

        // Inicializar tiendas
        const tiendas = [
            '4 IBM', '17 Leti Guarenas', '172 Leti Guarenas p.2', '172 Leti Guarenas p.4', '44 Parmalat', '045 Dronena',
            '046 Provincial', '047 Simple tv', '048 Leti Caracas piso 13', '049 Cocacola', '050 Dronena BQTO',
            '051 Latin Pagos', '052 Bnci', '053 Leti Caracas piso 2', '054 Simple cdt', '056 PWC', '057 Plumrose', 
            '058 Seguro Venezuela', '059 Rontarca', '062 BNC Rosal'
        ];

        const tiendaSelect = document.getElementById('tiendaSelect');
        tiendas.forEach(tienda => {
            const option = document.createElement('option');
            option.value = tienda;
            option.textContent = tienda;
            tiendaSelect.appendChild(option);
        });

        // Configurar fecha actual
        document.getElementById('fechaCierre').valueAsDate = new Date();

        // ===== TAB SWITCHING =====
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            if (tab === 'registro') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('tab-registro').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('tab-consolidado').classList.add('active');
                cargarCierresDesdeFirebase();
            }
        }

        // ===== CALCULAR TOTAL AUTOM√ÅTICAMENTE =====
        function calcularTotal() {
            const credito = parseFloat(document.getElementById('montoCredito').value) || 0;
            const debito = parseFloat(document.getElementById('montoDebito').value) || 0;
            const pagoMovil = parseFloat(document.getElementById('pagoMovil').value) || 0;
            
            const total = credito + debito + pagoMovil;
            document.getElementById('totalCalculado').textContent = `Bs ${total.toFixed(2)}`;
            
            validarFormulario();
        }

        document.getElementById('montoCredito').addEventListener('input', calcularTotal);
        document.getElementById('montoDebito').addEventListener('input', calcularTotal);
        document.getElementById('pagoMovil').addEventListener('input', calcularTotal);

        // ===== MANEJO DE FOTOS =====
        document.getElementById('takePictureBtn').addEventListener('click', async () => {
            if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                document.getElementById('cameraCapture').click();
            } else {
                await openCamera();
            }
        });

        document.getElementById('galleryFile').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        document.getElementById('cameraCapture').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        async function openCamera() {
            const cameraView = document.getElementById('cameraView');
            const video = document.getElementById('video');

            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = stream;
                cameraView.classList.remove('hidden');
            } catch (error) {
                alert('No se pudo acceder a la c√°mara. Por favor usa la opci√≥n de galer√≠a.');
            }
        }

        document.getElementById('captureBtn').addEventListener('click', () => {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);

            canvas.toBlob((blob) => {
                const file = new File([blob], `cierre_${Date.now()}.jpg`, { type: 'image/jpeg' });
                handleFile(file);
                closeCamera();
            }, 'image/jpeg', 0.95);
        });

        document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);

        function closeCamera() {
            const cameraView = document.getElementById('cameraView');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraView.classList.add('hidden');
        }

        function handleFile(file) {
            uploadedImage = file;
            displayPreview(file);
            validarFormulario();
        }

        function displayPreview(file) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';

            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="${e.target.result}" alt="Preview">
                    <button class="remove-btn" onclick="removeImage()">√ó</button>
                `;
                previewArea.appendChild(div);
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            uploadedImage = null;
            document.getElementById('previewArea').innerHTML = '';
            validarFormulario();
        }

        // ===== VALIDACI√ìN =====
        function validarFormulario() {
            const tienda = document.getElementById('tiendaSelect').value;
            const fecha = document.getElementById('fechaCierre').value;
            const hayImagen = uploadedImage !== null;
            const total = parseFloat(document.getElementById('totalCalculado').textContent.replace('Bs ', ''));
            
            const isValid = tienda && fecha && hayImagen && total > 0;
            document.getElementById('guardarBtn').disabled = !isValid;
        }

        document.getElementById('tiendaSelect').addEventListener('change', validarFormulario);
        document.getElementById('fechaCierre').addEventListener('change', validarFormulario);

        // ===== GUARDAR CIERRE EN FIREBASE =====
        document.getElementById('guardarBtn').addEventListener('click', async () => {
            const tienda = document.getElementById('tiendaSelect').value;
            const fecha = document.getElementById('fechaCierre').value;
            const credito = parseFloat(document.getElementById('montoCredito').value) || 0;
            const debito = parseFloat(document.getElementById('montoDebito').value) || 0;
            const pagoMovil = parseFloat(document.getElementById('pagoMovil').value) || 0;
            const total = credito + debito + pagoMovil;

            // Deshabilitar bot√≥n mientras guarda
            document.getElementById('guardarBtn').disabled = true;
            document.getElementById('guardarBtn').textContent = '‚è≥ Guardando...';

            try {
                // Convertir imagen a base64
                const imagenBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(uploadedImage);
                });

                // Crear documento para Firebase
                const cierre = {
                    tienda,
                    fecha,
                    credito,
                    debito,
                    pagoMovil,
                    total,
                    imagen: imagenBase64,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Buscar si ya existe un cierre para esta tienda y fecha
                const querySnapshot = await db.collection('cierres')
                    .where('tienda', '==', tienda)
                    .where('fecha', '==', fecha)
                    .get();

                if (!querySnapshot.empty) {
                    // Ya existe, preguntar si quiere reemplazar
                    if (confirm('Ya existe un cierre para esta tienda y fecha. ¬øDeseas reemplazarlo?')) {
                        const docId = querySnapshot.docs[0].id;
                        await db.collection('cierres').doc(docId).update(cierre);
                    } else {
                        document.getElementById('guardarBtn').disabled = false;
                        document.getElementById('guardarBtn').textContent = 'üíæ Guardar Cierre en la Nube';
                        return;
                    }
                } else {
                    // No existe, crear nuevo
                    await db.collection('cierres').add(cierre);
                }

                // Mostrar mensaje de √©xito
                const successMsg = document.getElementById('successMsg');
                successMsg.classList.remove('hidden');
                setTimeout(() => successMsg.classList.add('hidden'), 3000);

                // Limpiar formulario
                limpiarFormulario();

            } catch (error) {
                console.error('Error al guardar:', error);
                alert('Error al guardar en la base de datos: ' + error.message);
            }

            document.getElementById('guardarBtn').textContent = 'üíæ Guardar Cierre en la Nube';
        });

        function limpiarFormulario() {
            document.getElementById('tiendaSelect').value = '';
            document.getElementById('montoCredito').value = '0';
            document.getElementById('montoDebito').value = '0';
            document.getElementById('pagoMovil').value = '0';
            uploadedImage = null;
            document.getElementById('previewArea').innerHTML = '';
            calcularTotal();
            validarFormulario();
        }

        // ===== CARGAR CIERRES DESDE FIREBASE =====
        async function cargarCierresDesdeFirebase() {
            try {
                const snapshot = await db.collection('cierres').orderBy('timestamp', 'desc').get();
                const cierres = [];
                
                snapshot.forEach(doc => {
                    cierres.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                actualizarTablaConsolidado(cierres);
            } catch (error) {
                console.error('Error al cargar cierres:', error);
                document.getElementById('consolidadoContainer').innerHTML = 
                    '<div class="alert alert-warning">‚ö†Ô∏è Error al cargar datos de la nube</div>';
            }
        }

        // ===== MANEJO DE ARCHIVO SIMPLIT =====
        document.getElementById('simplitFile').addEventListener('change', handleSimplitFile);

        function handleSimplitFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const extension = file.name.split('.').pop().toLowerCase();

            if (extension === 'csv') {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const text = event.target.result;
                    
                    Papa.parse(text, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function(results) {
                            simplitData = results.data;
                            mostrarStatusSimplit(simplitData.length);
                        }
                    });
                };
                reader.readAsText(file);
            } else if (extension === 'xlsx' || extension === 'xls') {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    simplitData = XLSX.utils.sheet_to_json(worksheet);
                    mostrarStatusSimplit(simplitData.length);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function mostrarStatusSimplit(cantidad) {
            const status = document.getElementById('simplitStatus');
            status.className = 'alert alert-success';
            status.textContent = `‚úÖ ${cantidad} registros cargados de Simplit`;
            status.classList.remove('hidden');
            
            cargarCierresDesdeFirebase();
            document.getElementById('exportBtn').disabled = false;
        }

        // ===== ACTUALIZAR TABLA CONSOLIDADO =====
        function actualizarTablaConsolidado(cierres) {
            const container = document.getElementById('consolidadoContainer');

            if (cierres.length === 0) {
                container.innerHTML = '<div class="alert alert-info">üì≠ No hay cierres registrados todav√≠a</div>';
                return;
            }

            if (simplitData.length === 0) {
                container.innerHTML = generarTablaSinSimplit(cierres);
            } else {
                container.innerHTML = generarTablaConSimplit(cierres);
            }
        }

        function convertirMonto(valor) {
            if (!valor) return 0;

            valor = valor.toString();

            valor = valor.replace('Bs', '');
            valor = valor.replace(/\./g, '');
            valor = valor.replace(',', '.');

            return parseFloat(valor) || 0;
        }

        
        function generarTablaSinSimplit(cierres) {
            let html = '<table><thead><tr>';
            html += '<th>Tienda</th><th>Fecha</th><th>Cr√©dito</th><th>D√©bito</th><th>Pago M√≥vil</th><th>Total</th><th>Foto</th>';
            html += '</tr></thead><tbody>';

            cierres.forEach(cierre => {
                html += '<tr>';
                html += `<td>${cierre.tienda}</td>`;
                html += `<td>${cierre.fecha}</td>`;
                html += `<td>Bs ${cierre.credito.toFixed(2)}</td>`;
                html += `<td>Bs ${cierre.debito.toFixed(2)}</td>`;
                html += `<td>Bs ${cierre.pagoMovil.toFixed(2)}</td>`;
                html += `<td><strong>Bs ${cierre.total.toFixed(2)}</strong></td>`;
                html += `<td><a href="${cierre.imagen}" target="_blank">Ver üì∑</a></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        function generarTablaConSimplit(cierres) {
            let html = '<table><thead><tr>';
            html += '<th>Tienda</th><th>Fecha</th><th>Cr√©dito</th><th>D√©bito</th><th>Pago M√≥vil</th>';
            html += '<th>Total Cierre</th><th>Total Simplit</th><th>Diferencia</th><th>Estado</th><th>Foto</th>';
            html += '</tr></thead><tbody>';

            cierres.forEach(cierre => {
                const simplitRecord = simplitData.find(s => {
                    const tiendaSimplit = (s.Tienda || s.tienda || '').trim();
                    const tiendaCierre = cierre.tienda.trim();
                    const fechaSimplit = (s.Fecha || s.fecha || '').trim();
                    const fechaCierre = cierre.fecha.trim();
                    
                    const fechaCoincide = fechaSimplit.includes(fechaCierre) || 
                                         fechaCierre.includes(fechaSimplit) ||
                                         fechaSimplit === fechaCierre;
                    
                    const tiendaCoincideExacta = tiendaSimplit.toLowerCase() === tiendaCierre.toLowerCase();
                    
                    const codigoTiendaCierre = tiendaCierre.match(/^\d+/);
                    const codigoTiendaSimplit = tiendaSimplit.match(/^\d+/);
                    const tiendaCoincideCodigo = codigoTiendaCierre && codigoTiendaSimplit && 
                                                  codigoTiendaCierre[0] === codigoTiendaSimplit[0];
                    
                    return fechaCoincide && (tiendaCoincideExacta || tiendaCoincideCodigo);
                });

                const totalSimplit = simplitRecord ? parseFloat(simplitRecord.Total_Ventas || simplitRecord.total_ventas || 0) : 0;
                const diferencia = cierre.total - totalSimplit;
                const estado = Math.abs(diferencia) <= 1 ? 'ok' : (Math.abs(diferencia) <= 10 ? 'pending' : 'error');

                html += '<tr>';
                html += `<td>${cierre.tienda}</td>`;
                html += `<td>${cierre.fecha}</td>`;
                html += `<td>Bs ${cierre.credito.toFixed(2)}</td>`;
                html += `<td>Bs ${cierre.debito.toFixed(2)}</td>`;
                html += `<td>Bs ${cierre.pagoMovil.toFixed(2)}</td>`;
                html += `<td><strong>Bs ${cierre.total.toFixed(2)}</strong></td>`;
                html += `<td><strong>Bs ${totalSimplit.toFixed(2)}</strong></td>`;
                html += `<td style="color: ${diferencia >= 0 ? '#28a745' : '#dc3545'}"><strong>${diferencia >= 0 ? '+' : ''}Bs ${diferencia.toFixed(2)}</strong></td>`;
                
                let estadoTexto = estado === 'ok' ? '‚úÖ CUADRA' : (estado === 'pending' ? '‚ö†Ô∏è DIF. MENOR' : '‚ùå NO CUADRA');
                html += `<td><span class="status-${estado}">${estadoTexto}</span></td>`;
                html += `<td><a href="${cierre.imagen}" target="_blank">Ver üì∑</a></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            return html;
        }

        // ===== EXPORTAR A EXCEL =====
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const snapshot = await db.collection('cierres').get();
                const cierres = [];
                
                snapshot.forEach(doc => {
                    cierres.push(doc.data());
                });

                const datos = [];
                datos.push(['Tienda', 'Fecha', 'Cr√©dito', 'D√©bito', 'Pago M√≥vil', 'Total Cierre', 'Total Simplit', 'Diferencia', 'Estado']);

                cierres.forEach(cierre => {
                    const simplitRecord = simplitData.find(s => {
                        const tiendaSimplit = (s.Tienda || s.tienda || '').trim();
                        const tiendaCierre = cierre.tienda.trim();
                        const fechaSimplit = (s.Fecha || s.fecha || '').trim();
                        const fechaCierre = cierre.fecha.trim();
                        
                        const fechaCoincide = fechaSimplit.includes(fechaCierre) || fechaCierre.includes(fechaSimplit) || fechaSimplit === fechaCierre;
                        const tiendaCoincideExacta = tiendaSimplit.toLowerCase() === tiendaCierre.toLowerCase();
                        
                        const codigoTiendaCierre = tiendaCierre.match(/^\d+/);
                        const codigoTiendaSimplit = tiendaSimplit.match(/^\d+/);
                        const tiendaCoincideCodigo = codigoTiendaCierre && codigoTiendaSimplit && codigoTiendaCierre[0] === codigoTiendaSimplit[0];
                        
                        return fechaCoincide && (tiendaCoincideExacta || tiendaCoincideCodigo);
                    });

                    const totalSimplit = simplitRecord ? convertirMonto(simplitRecord.Total_Ventas || simplitRecord.total_ventas) : 0;
                    const diferencia = cierre.total - totalSimplit;
                    const estado = Math.abs(diferencia) <= 1 ? 'CUADRA' : (Math.abs(diferencia) <= 10 ? 'DIF_MENOR' : 'NO_CUADRA');

                    datos.push([
                        cierre.tienda,
                        cierre.fecha,
                        cierre.credito,
                        cierre.debito,
                        cierre.pagoMovil,
                        cierre.total,
                        totalSimplit,
                        diferencia,
                        estado
                    ]);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(datos);

                ws['!cols'] = [
                    { wch: 25 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                    { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 12 }
                ];

                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = 1; R <= range.e.r; ++R) {
                    for (let C = 2; C <= 7; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (ws[cellAddress]) {
                            ws[cellAddress].z = '#,##0.00';
                        }
                    }
                }

                XLSX.utils.book_append_sheet(wb, ws, 'Consolidado Cierres');

                const fecha = new Date().toISOString().split('T')[0];
                XLSX.writeFile(wb, `Consolidado_Cierres_${fecha}.xlsx`);
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al exportar: ' + error.message);
            }
        });

        // ===== LIMPIAR DATOS DE FIREBASE =====
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if (confirm('¬øEst√°s seguro de que deseas eliminar TODOS los cierres de la base de datos? Esta acci√≥n no se puede deshacer.')) {
                try {
                    const snapshot = await db.collection('cierres').get();
                    const batch = db.batch();
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                    alert('‚úÖ Todos los datos han sido eliminados de la nube');
                    cargarCierresDesdeFirebase();
                } catch (error) {
                    console.error('Error al eliminar:', error);
                    alert('Error al eliminar datos: ' + error.message);
                }
            }
        });

        // Cargar cierres al inicio
        cargarCierresDesdeFirebase();
    </script>
</body>
</html>
