<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificador de Cierres de Caja - Sistema Multi-Tienda</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title::before {
            content: '';
            width: 5px;
            height: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-area.drag-over {
            background: #e7eeff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .tienda-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .tienda-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tienda-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .tienda-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .preview-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preview-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .preview-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .preview-item .remove-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            display: inline-block;
        }

        .status-ok {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .difference {
            font-weight: bold;
        }

        .difference.positive {
            color: #28a745;
        }

        .difference.negative {
            color: #dc3545;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-top: 4px solid #667eea;
        }

        .summary-card h3 {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        #exportBtn {
            background: #28a745;
            margin-left: 10px;
        }

        #exportBtn:hover {
            background: #218838;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Verificador de Cierres de Caja</h1>
            <p>Sistema Autom√°tico de Validaci√≥n Multi-Tienda</p>
        </div>

        <div class="main-content">
            <!-- Paso 1: Cargar datos de Simplit -->
            <div class="section">
                <div class="section-title">üìä Paso 1: Cargar Datos de Simplit (Excel/CSV)</div>
                <div class="alert alert-info">
                    üí° Carga el archivo Excel con los datos del sistema Simplit. Debe contener las columnas: Tienda, Fecha, Total_Ventas
                </div>
                <input type="file" id="simplitFile" accept=".csv,.xlsx,.xls">
                <div class="upload-area" onclick="document.getElementById('simplitFile').click()">
                    <div style="font-size: 3em; margin-bottom: 10px;">üìÅ</div>
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                        Arrastra el archivo de Simplit aqu√≠
                    </div>
                    <div style="color: #6c757d;">o haz clic para seleccionar</div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        Formatos: CSV, Excel (.xlsx, .xls)
                    </div>
                </div>
                <div id="simplitStatus" class="hidden" style="margin-top: 15px;"></div>
            </div>

            <!-- Paso 2: Seleccionar tienda y fecha -->
            <div class="section">
                <div class="section-title">üè¨ Paso 2: Configurar Verificaci√≥n</div>
                <div class="two-column">
                    <div class="input-group">
                        <label>Seleccionar Tienda:</label>
                        <select id="tiendaSelect">
                            <option value="">-- Selecciona una tienda --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fecha del Cierre:</label>
                        <input type="date" id="fechaCierre" value="">
                    </div>
                </div>
                <div class="input-group">
                    <label>Total Pago M√≥vil (Bs):</label>
                    <input type="number" id="pagoMovil" placeholder="Ejemplo: 1500.00" step="0.01">
                </div>
            </div>

            <!-- Paso 3: Subir foto del cierre -->
            <div class="section">
                <div class="section-title">üì∏ Paso 3: Subir Foto del Cierre de Caja</div>
                <input type="file" id="cierreFile" accept="image/*" multiple>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3em; margin-bottom: 10px;">üì∑</div>
                    <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 5px;">
                        Arrastra las fotos del cierre aqu√≠
                    </div>
                    <div style="color: #6c757d;">o haz clic para seleccionar</div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        Formatos: JPG, PNG, JPEG
                    </div>
                </div>
                <div class="preview-area" id="previewArea"></div>
                
                <div class="progress-container" id="progressContainer">
                    <div style="margin-bottom: 10px; font-weight: 600;">Procesando im√°genes...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill">0%</div>
                    </div>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" id="processBtn" disabled>üîç Procesar y Verificar</button>
                    <button class="btn" id="exportBtn" style="display: none;">üì• Exportar Reporte</button>
                </div>
            </div>

            <!-- Resultados -->
            <div class="section hidden" id="resultsSection">
                <div class="section-title">‚úÖ Resultados de la Verificaci√≥n</div>
                
                <div class="summary-cards" id="summaryCards"></div>
                
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let simplitData = [];
        let uploadedImages = [];
        let currentTienda = '';
        let currentFecha = '';
        
        // Configurar fecha actual
        document.getElementById('fechaCierre').valueAsDate = new Date();

        // Inicializar tiendas (puedes modificar esta lista)
        const tiendas = [
            'Tienda 01', 'Tienda 02', 'Tienda 03', 'Tienda 04', 'Tienda 05',
            'Tienda 06', 'Tienda 07', 'Tienda 08', 'Tienda 09', 'Tienda 10',
            'Tienda 11', 'Tienda 12', 'Tienda 13', 'Tienda 14', 'Tienda 15',
            'Tienda 16', 'Tienda 17', 'Tienda 18', 'Tienda 19', 'Tienda 20'
        ];

        const tiendaSelect = document.getElementById('tiendaSelect');
        tiendas.forEach(tienda => {
            const option = document.createElement('option');
            option.value = tienda;
            option.textContent = tienda;
            tiendaSelect.appendChild(option);
        });

        // Manejo de archivo Simplit
        document.getElementById('simplitFile').addEventListener('change', handleSimplitFile);

        function handleSimplitFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                
                // Parsear CSV
                Papa.parse(text, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        simplitData = results.data;
                        showSimplitStatus(true, `‚úÖ ${simplitData.length} registros cargados correctamente`);
                        updateProcessButton();
                    },
                    error: function(error) {
                        showSimplitStatus(false, '‚ùå Error al leer el archivo');
                    }
                });
            };
            reader.readAsText(file);
        }

        function showSimplitStatus(success, message) {
            const status = document.getElementById('simplitStatus');
            status.className = success ? 'alert alert-success' : 'alert alert-danger';
            status.textContent = message;
            status.classList.remove('hidden');
        }

        // Manejo de im√°genes
        const uploadArea = document.getElementById('uploadArea');
        const cierreFile = document.getElementById('cierreFile');

        uploadArea.addEventListener('click', () => cierreFile.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });

        cierreFile.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            uploadedImages = Array.from(files);
            displayPreviews();
            updateProcessButton();
        }

        function displayPreviews() {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';

            uploadedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button class="remove-btn" onclick="removeImage(${index})">√ó</button>
                    `;
                    previewArea.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            displayPreviews();
            updateProcessButton();
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            const hasData = simplitData.length > 0;
            const hasImages = uploadedImages.length > 0;
            const hasTienda = document.getElementById('tiendaSelect').value !== '';
            
            btn.disabled = !(hasData && hasImages && hasTienda);
        }

        document.getElementById('tiendaSelect').addEventListener('change', updateProcessButton);

        // Procesar im√°genes con OCR
        document.getElementById('processBtn').addEventListener('click', async () => {
            const tienda = document.getElementById('tiendaSelect').value;
            const fecha = document.getElementById('fechaCierre').value;
            const pagoMovil = parseFloat(document.getElementById('pagoMovil').value) || 0;

            if (!tienda || !fecha) {
                alert('Por favor selecciona tienda y fecha');
                return;
            }

            currentTienda = tienda;
            currentFecha = fecha;

            // Mostrar progreso
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'block';

            let totalExtracted = 0;
            const progressFill = document.getElementById('progressFill');

            for (let i = 0; i < uploadedImages.length; i++) {
                progressFill.style.width = ((i / uploadedImages.length) * 100) + '%';
                progressFill.textContent = `${Math.round((i / uploadedImages.length) * 100)}%`;

                const text = await extractTextFromImage(uploadedImages[i]);
                const amount = extractAmount(text);
                totalExtracted += amount;
            }

            progressFill.style.width = '100%';
            progressFill.textContent = '100%';

            // Calcular total de cierre
            const totalCierre = totalExtracted + pagoMovil;

            // Buscar dato en Simplit
            const simplitRecord = findSimplitRecord(tienda, fecha);

            // Mostrar resultados
            displayResults(totalCierre, pagoMovil, totalExtracted, simplitRecord);

            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 1000);
        });

        async function extractTextFromImage(file) {
            try {
                const result = await Tesseract.recognize(file, 'spa', {
                    logger: m => console.log(m)
                });
                return result.data.text;
            } catch (error) {
                console.error('Error en OCR:', error);
                return '';
            }
        }

        function extractAmount(text) {
            // Buscar patrones de montos: n√∫meros con decimales
            const patterns = [
                /total[:\s]*([0-9,.]+)/i,
                /TOTAL[:\s]*([0-9,.]+)/i,
                /([0-9]{1,10}[.,][0-9]{2})/g,
                /Bs[.\s]*([0-9,.]+)/i
            ];

            for (let pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const numStr = match[1] || match[0];
                    const num = parseFloat(numStr.replace(/,/g, '').replace(/\./g, ''));
                    if (num > 0) return num;
                }
            }

            return 0;
        }

        function findSimplitRecord(tienda, fecha) {
            return simplitData.find(record => {
                const recordTienda = record.Tienda || record.tienda || '';
                const recordFecha = record.Fecha || record.fecha || '';
                return recordTienda.toLowerCase().includes(tienda.toLowerCase()) && 
                       recordFecha.includes(fecha);
            });
        }

        function displayResults(totalCierre, pagoMovil, efectivo, simplitRecord) {
            const resultsSection = document.getElementById('resultsSection');
            const summaryCards = document.getElementById('summaryCards');
            const resultsContent = document.getElementById('resultsContent');

            resultsSection.classList.remove('hidden');

            const simplitTotal = simplitRecord ? parseFloat(simplitRecord.Total_Ventas || simplitRecord.total_ventas || 0) : 0;
            const diferencia = totalCierre - simplitTotal;
            const porcentajeDif = simplitTotal > 0 ? ((diferencia / simplitTotal) * 100).toFixed(2) : 0;

            // Cards de resumen
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h3>Total Cierre Caja</h3>
                    <div class="value">Bs ${totalCierre.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>Total Simplit</h3>
                    <div class="value">Bs ${simplitTotal.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <h3>Diferencia</h3>
                    <div class="value" style="color: ${diferencia === 0 ? '#28a745' : '#dc3545'}">
                        Bs ${diferencia.toFixed(2)}
                    </div>
                </div>
                <div class="summary-card">
                    <h3>Estado</h3>
                    <div class="value" style="font-size: 1.5em;">
                        ${Math.abs(diferencia) <= 1 ? '‚úÖ' : '‚ö†Ô∏è'}
                    </div>
                </div>
            `;

            // Tabla detallada
            const status = Math.abs(diferencia) <= 1 ? 'ok' : (Math.abs(diferencia) <= 10 ? 'warning' : 'error');
            const statusText = status === 'ok' ? 'CUADRA ‚úÖ' : (status === 'warning' ? 'DIFERENCIA MENOR ‚ö†Ô∏è' : 'NO CUADRA ‚ùå');

            resultsContent.innerHTML = `
                <div class="alert ${status === 'ok' ? 'alert-success' : 'alert-danger'}">
                    <strong>${statusText}</strong> - ${currentTienda} - ${currentFecha}
                </div>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Concepto</th>
                            <th>Monto (Bs)</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Efectivo (OCR)</strong></td>
                            <td>Bs ${efectivo.toFixed(2)}</td>
                            <td>${uploadedImages.length} imagen(es) procesada(s)</td>
                        </tr>
                        <tr>
                            <td><strong>Pago M√≥vil</strong></td>
                            <td>Bs ${pagoMovil.toFixed(2)}</td>
                            <td>Ingresado manualmente</td>
                        </tr>
                        <tr style="background: #f0f4ff;">
                            <td><strong>TOTAL CIERRE</strong></td>
                            <td><strong>Bs ${totalCierre.toFixed(2)}</strong></td>
                            <td>Efectivo + Pago M√≥vil</td>
                        </tr>
                        <tr style="background: #fff8e1;">
                            <td><strong>TOTAL SIMPLIT</strong></td>
                            <td><strong>Bs ${simplitTotal.toFixed(2)}</strong></td>
                            <td>Desde sistema de facturaci√≥n</td>
                        </tr>
                        <tr style="background: ${Math.abs(diferencia) <= 1 ? '#d4edda' : '#f8d7da'}">
                            <td><strong>DIFERENCIA</strong></td>
                            <td class="difference ${diferencia >= 0 ? 'positive' : 'negative'}">
                                <strong>${diferencia >= 0 ? '+' : ''}Bs ${diferencia.toFixed(2)}</strong>
                            </td>
                            <td>
                                <span class="status-badge status-${status}">${statusText}</span>
                                ${Math.abs(porcentajeDif) > 0 ? `(${porcentajeDif}%)` : ''}
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;

            document.getElementById('exportBtn').style.display = 'inline-block';
        }

        // Exportar reporte
        document.getElementById('exportBtn').addEventListener('click', () => {
            const fecha = document.getElementById('fechaCierre').value;
            const tienda = document.getElementById('tiendaSelect').value;
            
            const content = document.getElementById('resultsContent').innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Reporte_${tienda}_${fecha}.txt`;
            a.click();
        });
    </script>
</body>
</html>
